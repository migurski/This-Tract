<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="http://isithackday.com/hacks/geo/yql-geo-library/yqlgeo.js"></script>
    <script type="text/javascript" src="http://code.modestmaps.com/0.13.2/modestmaps.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.3.min.js"></script>
    <title>Innit</title>
    <style type="text/css" title="text/css">
    <!--
    
        body
        {
            font-family: Helvetica, Arial, sans-serif;
        }
        
        ol li
        {
            list-style-type: none;
        }
        
        h2, dd
        {
            font-size: 2em;
            font-weight: bold;
        }
        
        dd
        {
            color: #31a354;
        }
        
        h2, dd, p
        {
            margin-bottom: 1em;
        }
        
        h2, dt, dd, p
        {
            text-align: center;
            margin-left: 0;
            width: 900px;
        }
        
        sup
        {
            vertical-align: baseline;
            position: relative;
            font-size: .65em;
            bottom: .5em;
        }
        
        #block { display: none; }
        
        .gender-chart { height: 100px; }
        .age-chart, .race-chart, .housing-chart { height: 150px; }

        #tract-map
        {
            /* border: 1px solid rgba(49, 163, 84, .2); */
            margin-left: 100px;
            width: 700px;
            height: 600px;
        }

    -->
    </style>
    <script type="text/javascript">
    <!--
    
        function bigNumber(value)
        {
            if(value < 10)
            {
                return value.toFixed(1);
            }
        
            var valueText = value.toFixed(0);
            
            while(valueText.match(/\d{4}\b/))
            {
                valueText = valueText.replace(/^(\d+)(\d{3}\b.*)$/, '$1,$2');
            }
            
            return valueText;
        }
    
        function dodemographics(id, demographics)
        {
            var population = demographics[0][0];
            var housing = demographics[1][0];
            
            $([id, '.population-number'].join(' ')).text(bigNumber(population));
            $([id, '.housing-number'].join(' ')).text(bigNumber(housing));
            
            function raceChart()
            {
                var counts = [], races = [];
                
                for(var i = 2; i <= 8; i += 1)
                {
                    var count = bigNumber(100 * demographics[i][0] / population);
    
                    counts.push(count);
                    races.push(escape(count + '% ' + demographics[i][1]));
                }
                
                var chart = new Image();
    
                chart.src = ['http://chart.apis.google.com/chart?cht=p',
                             '&chs=900x150',
                             '&chco=9c9ede|7375b5|4a5584|cedb9c|b5cf6b|8ca252|637939',
                             '&chd=t:', counts.join(','),
                             '&chl=', races.join('|')].join('');
                
                return chart;
            }
            
            function genderChart()
            {
                var counts = [
                              (100 * demographics[9][0] / population).toFixed(1),
                              (100 * demographics[33][0] / population).toFixed(1)
                             ];
                
                var genders = [counts[0] + '% Male', counts[1] + '% Female'];
                
                var chart = new Image();
                
                chart.src = ['http://chart.apis.google.com/chart?cht=p',
                             '&chs=900x100',
                             '&chco=c2e699|31a354',
                             '&chd=t:', counts.join(','),
                             '&chl=', genders.join('|')].join('');
                
                return chart;
            }
            
            function ageChart()
            {
                var counts = [], ages = [];
                
                var blocks = [['Under 18', 10, 13, 34, 37],
                              ['Age 18 to 29', 14, 18, 38, 42],
                              ['Age 30 to 44', 19, 21, 43, 45],
                              ['Age 45 to 64', 22, 26, 46, 50],
                              ['Age 65 and up', 27, 32, 51, 56]];
                
                for(var i = 0; i < blocks.length; i += 1)
                {
                    var age = blocks[i][0], count = 0;
                    
                    for(var j = blocks[i][1]; j <= blocks[i][2]; j += 1)
                    {
                        count += demographics[j][0];
                    }
                    
                    for(var j = blocks[i][3]; j <= blocks[i][4]; j += 1)
                    {
                        count += demographics[j][0];
                    }
                    
                    count = bigNumber(100 * count / population);
                    
                    counts.push(count);
                    ages.push(count + '% ' + age);
                }
                
                var chart = new Image();
                
                chart.src = ['http://chart.apis.google.com/chart?cht=p',
                             '&chs=900x150',
                             '&chco=ffffcc|c2e699|78c679|31a354|006837',
                             '&chd=t:', counts.join(','),
                             '&chl=', ages.join('|')].join('');
                
                return chart;
            }
            
            function housingChart()
            {
                var counts = [], houses = [];
                
                var blocks = [['6 and more person households', 62, 63, 70, 71],
                              ['4 and 5 person households', 60, 61, 68, 69],
                              ['Three person households', 59, 59, 67, 67],
                              ['Two person households', 58, 58, 66, 66],
                              ['One person households', -1, -2, 65, 65]];
                
                for(var i = 0; i < blocks.length; i += 1)
                {
                    var house = blocks[i][0], count = 0;
                    
                    for(var j = blocks[i][1]; j <= blocks[i][2]; j += 1)
                    {
                        count += demographics[j][0];
                    }
                    
                    for(var j = blocks[i][3]; j <= blocks[i][4]; j += 1)
                    {
                        count += demographics[j][0];
                    }
                    
                    count = bigNumber(100 * count / housing);
                    
                    counts.push(count);
                    houses.push(count + '% ' + house);
                }
                
                var chart = new Image();
                
                chart.src = ['http://chart.apis.google.com/chart?cht=p',
                             '&chs=900x150',
                             '&chco=006837|31a354|78c679|c2e699|ffffcc',
                             '&chd=t:', counts.join(','),
                             '&chl=', houses.join('|')].join('');
                
                return chart;
            }

            $([id, '.race-chart'].join(' ')).append(raceChart());
            $([id, '.gender-chart'].join(' ')).append(genderChart());
            $([id, '.age-chart'].join(' ')).append(ageChart());
            $([id, '.housing-chart'].join(' ')).append(housingChart());
        }
        
        function domap(id, geometry)
        {
            var width = 700, height = 600, mm = com.modestmaps;
            
            var locations = [], points = [];
            
            for(var i = 0; i < geometry.coordinates[0].length; i += 1)
            {
                var coord = geometry.coordinates[0][i];
                locations.push(new mm.Location(coord[1], coord[0]));
            }
            
            var template = 'http://otile1.mqcdn.com/tiles/1.0.0/osm/{Z}/{X}/{Y}.png';
            var provider = new mm.TemplatedMapProvider(template);
            var element = document.getElementById(id);
            var map = new mm.Map(element, provider, new mm.Point(width, height), []);
            map.setExtent(locations);
            map.draw();
            
            var ymin = height, ymax = 0;
            
            for(var i = 0; i < locations.length; i += 1)
            {
                var point = map.locationPoint(locations[i]);
                points.push(point);
                
                ymin = Math.min(ymin, point.y);
                ymax = Math.max(ymax, point.y);
            }
            
            height = Math.ceil(4 + ymax - ymin);
            
            map.setSize(width, height);
            
            for(var i = 0; i < locations.length; i += 1)
            {
                points[i] = map.locationPoint(locations[i]);
            }
            
            var canvas = document.createElement('canvas');
            canvas.style.position = 'absolute';
            canvas.width = width;
            canvas.height = height;
            map.parent.appendChild(canvas);
            
            var ctx = canvas.getContext('2d');
            
            if(ctx)
            {
                var start = points[points.length - 1];
                
                ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                ctx.beginPath();
                
                ctx.moveTo(0, 0);
                ctx.lineTo(0, height);
                ctx.lineTo(width, height);
                ctx.lineTo(width, 0);
                ctx.lineTo(0, 0);

                ctx.moveTo(start.x, start.y);
                
                for(var i = 0; i < points.length; i += 1)
                {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                
                ctx.closePath();
                ctx.fill();
                
                ctx.strokeStyle = 'rgba(49, 163, 84, 1)';
                
                ctx.moveTo(start.x, start.y);
                ctx.beginPath();
                
                for(var i = 0; i < points.length; i += 1)
                {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                
                ctx.closePath();
                ctx.stroke();
            }
        }
    
        function onstate(o)
        {
            console.log(['state', o]);
            
            $('#state .name').text(o.Name);
            $('#state .landarea-number').html(bigNumber(o.Geography['Land Area'] / 1000000) + ' km<sup>2<'+'/sup>');
            $('#state .waterarea-number').html(bigNumber(o.Geography['Water Area'] / 1000000) + ' km<sup>2<'+'/sup>');
            
            dodemographics('#state', o.Demographics);
        }
    
        function oncounty(o)
        {
            console.log(['county', o]);
            
            $('#county .name').text(o.Name);
            $('#county .landarea-number').html(bigNumber(o.Geography['Land Area'] / 1000000) + ' km<sup>2<'+'/sup>');
            $('#county .waterarea-number').html(bigNumber(o.Geography['Water Area'] / 1000000) + ' km<sup>2<'+'/sup>');
            
            dodemographics('#county', o.Demographics);
        }
    
        function ontract(o)
        {
            console.log(['tract', o]);
            
            $('#tract .name').text(o.Name);
            $('#tract .landarea-number').html(bigNumber(o.Geography['Land Area'] / 1000000) + ' km<sup>2<'+'/sup>');
            $('#tract .waterarea-number').html(bigNumber(o.Geography['Water Area'] / 1000000) + ' km<sup>2<'+'/sup>');
            
            dodemographics('#tract', o.Demographics);
            domap('tract-map', o.Geography.geometry);
        }
    
        function onblock(o)
        {
            console.log(['block', o]);
            
            $('#block .name').text('Block ' + o.Block.FIPS);
    
            if(!o.Block.FIPS.match(/^(\d{2})(\d{3})(\d{6})(\d{4})/))
            {
                console.log([o.Block.FIPS, '?!']);
                return;
            }
            
            var tract = o.Block.FIPS.replace(/^(\d{2})(\d{3})(\d{6}).+$/, 'http://this-tract.s3.amazonaws.com/tracts/$1/$2/$3.json');
            var county = o.Block.FIPS.replace(/^(\d{2})(\d{3}).+$/, 'http://this-tract.s3.amazonaws.com/counties/$1/$2.json');
            var state = o.Block.FIPS.replace(/^(\d{2}).+$/, 'http://this-tract.s3.amazonaws.com/states/$1.json');
            
            console.log(tract);
            console.log(county);
            console.log(county);

            var script = document.createElement('script');
            script.src = 'slimjim.php?callback=ontract&url=' + escape(tract);
            document.body.appendChild(script);

            var script = document.createElement('script');
            script.src = 'slimjim.php?callback=oncounty&url=' + escape(county);
            document.body.appendChild(script);

            var script = document.createElement('script');
            script.src = 'slimjim.php?callback=onstate&url=' + escape(state);
            document.body.appendChild(script);
        }

        function onlocation(o)
        {
            console.log(o);

            var url = ['http://data.fcc.gov/api/block/2000/find',
                       '?format=jsonp',
                       '&callback=onblock',
                       '&latitude=', o.place.centroid.latitude,
                       '&longitude=', o.place.centroid.longitude];

            var script = document.createElement('script');
            script.src = url.join('');
            document.body.appendChild(script);
        }

        function onPlaceSearch(o)
        {
            console.log(o);
            
            if(o.results.length)
            {
                var latlon = o.results[0].locations[0].latLng;
                var center = {'latitude': latlon.lat, 'longitude': latlon.lng};
                onlocation({'place': {'centroid': center}});
            }
        }
        
    //-->
    </script>
</head>
<body>

    <form method="get">
        <input type="text" name="q" id="location-q" size="40" value="">
        <input type="submit">
    </form>
    
    <script type="text/javascript">
    <!--
        var getlocation = true;
        
        if(location.search.match(/^\?/))
        {
            var parts = location.search.substr(1).split('&');
            
            for(var i = 0; i < parts.length; i += 1)
            {
                if(parts[i].match(/^q=.+$/))
                {
                    var q = unescape(parts[i].substr(2).replace(/\+/g, '%20'));
                    
                    if(q.match(/^\s*-?\d+(\.\d+)?[\,\s]+-?\d+(\.\d+)?\s*$/))
                    {
                        q = q.replace(/^\s*(\S.+\S)\s*$/, '$1');
                        var latlon = q.split(/[\,\s]+/);
                        latlon = [parseFloat(latlon[0]), parseFloat(latlon[1])];
                        q = latlon[0].toFixed(6) + ', ' + latlon[1].toFixed(6);
                        var loc = {'place': {'centroid': {'latitude': latlon[0], 'longitude': latlon[1]}}};
                        onlocation(loc);

                    } else {
                        var appid = 'Dmjtd|lu612007nq,20=o5-50zah';
                        //var appid = unescape('Fmjtd%7Cluu7nu0rn0%2Cag%3Do5-5z1xq');
                        
                        var url = ['http://www.mapquestapi.com/geocoding/v1/address',
                                   '?inFormat=kvp&outFormat=json',
                                   '&key=' + escape(appid),
                                   '&location=' + escape(q),
                                   '&callback=onPlaceSearch'];
            
                        var script = document.createElement('script');
                        script.src = url.join('');
                        document.body.appendChild(script);
                    }
                    
                    document.getElementById('location-q').value = q;
                    
                    getlocation = false;
                    break;
                }
            }
        }
        
        if(getlocation)
        {
            /*
            yqlgeo.get('visitor', onlocation);
            */
            var loc = {'place': {'centroid': {'latitude': 40.60274481122281, 'longitude': -75.44689178466797}}}; // testing
            var loc = {'place': {'centroid': {'latitude': 37.804372, 'longitude': -122.270803}}}; // downtown
            var loc = {'place': {'centroid': {'latitude': 37.764863, 'longitude': -122.419313}}}; // 16th & mission
            var loc = {'place': {'centroid': {'latitude': 37.804189, 'longitude': -122.263198}}}; // 17th & jackson
            onlocation(loc);
        }

    //-->
    </script>
    
    <ol>
        <li id="block">
            <h2 class="name">…</h2>
        </li>
        <li id="tract">
            <div id="tract-map"></div>
            <h2 class="name">…</h2>
            <dl>
                <dt>Population</dt><dd class="population-number">…</dd>
                <dt>Housing units</dt><dd class="housing-number">…</dd>
                <dt>Land Area</dt><dd class="landarea-number">…</dd>
                <dt>Water Area</dt><dd class="waterarea-number">…</dd>
            </dl>
            <p class="gender-chart"></p>
            <p class="age-chart"></p>
            <p class="race-chart"></p>
            <p class="housing-chart"></p>
        </li>
        <li id="county">
            <h2 class="name">…</h2>
            <dl>
                <dt>Population</dt><dd class="population-number">…</dd>
                <dt>Housing units</dt><dd class="housing-number">…</dd>
                <dt>Land Area</dt><dd class="landarea-number">…</dd>
                <dt>Water Area</dt><dd class="waterarea-number">…</dd>
            </dl>
            <p class="gender-chart"></p>
            <p class="age-chart"></p>
            <p class="race-chart"></p>
            <p class="housing-chart"></p>
        </li>
        <li id="state">
            <h2 class="name">…</h2>
            <dl>
                <dt>Population</dt><dd class="population-number">…</dd>
                <dt>Housing units</dt><dd class="housing-number">…</dd>
                <dt>Land Area</dt><dd class="landarea-number">…</dd>
                <dt>Water Area</dt><dd class="waterarea-number">…</dd>
            </dl>
            <p class="gender-chart"></p>
            <p class="age-chart"></p>
            <p class="race-chart"></p>
            <p class="housing-chart"></p>
        </li>
    </ol>

</body>
</html>
